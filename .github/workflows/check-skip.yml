name: Check Skip File

on:
  workflow_call:
    outputs:
      should_skip:
        description: "Whether to skip Claude CI/CD"
        value: ${{ jobs.check-skip.outputs.should_skip }}

jobs:
  check-skip:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.check_skip_file.outputs.skip }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Check for .skip file
        id: check_skip_file
        env:
          EXPECTED_SKIP_HASH: ${{ secrets.SKIP_FILE_HASH }}
        run: |
          # Nerd Font Icons
          CHECK=""
          WARN=""
          INFO=""
          SKIP_FILE=".github/skips/.skip"

          if [ ! -f "$SKIP_FILE" ]; then
            echo "skip=false" >> $GITHUB_OUTPUT
            echo -e "${CHECK}  No skip file - proceeding with CI/CD"
            exit 0
          fi

          SKIP_FILE_HASH=$(sha256sum "$SKIP_FILE" | awk '{print $1}')

          if [ -n "$EXPECTED_SKIP_HASH" ]; then
            if [ "$SKIP_FILE_HASH" = "$EXPECTED_SKIP_HASH" ]; then
              echo "skip=true" >> $GITHUB_OUTPUT
              echo -e "${CHECK}  Skip file verified (hash) - skipping CI/CD"
            else
              echo "skip=false" >> $GITHUB_OUTPUT
              echo -e "${WARN}  Skip file hash mismatch - proceeding for security"
            fi
          else
            SKIP_CONTENT=$(cat "$SKIP_FILE" | tr -d '[:space:]')
            if [ "$SKIP_CONTENT" = "SKIP_CLAUDE_CI_APPROVED" ]; then
              echo "skip=true" >> $GITHUB_OUTPUT
              echo -e "${CHECK}  Skip file verified (content) - skipping CI/CD"
            else
              echo "skip=false" >> $GITHUB_OUTPUT
              echo -e "${WARN}  Skip file invalid - proceeding for security"
              echo -e "${INFO}  See .github/skips/SKIP_SYSTEM.md for setup"
            fi
          fi
