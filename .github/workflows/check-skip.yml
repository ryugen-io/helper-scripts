name: Check Skip File

on:
  workflow_call:
    outputs:
      should_skip:
        description: "Whether to skip Claude CI/CD"
        value: ${{ jobs.check-skip.outputs.should_skip }}

jobs:
  check-skip:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.check_skip_file.outputs.skip }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Check for .skip file
        id: check_skip_file
        env:
          EXPECTED_SKIP_HASH: ${{ secrets.SKIP_FILE_HASH }}
        run: |
          source .github/workflows/scripts/ci-logger.sh

          log_header "CI/CD Skip Check"

          SKIP_FILE=".github/skips/.skip"

          if [ ! -f "$SKIP_FILE" ]; then
            echo "skip=false" >> $GITHUB_OUTPUT
            log_success "No skip file found - CI/CD will proceed"
            log_info "Workflow log saved to: ${LOG_FILE}"
            exit 0
          fi

          log_info "Skip file found at: ${SKIP_FILE}"
          SKIP_FILE_HASH=$(sha256sum "$SKIP_FILE" | awk '{print $1}')

          if [ -n "$EXPECTED_SKIP_HASH" ]; then
            log_step "verify" "Verifying skip file hash..."
            if [ "$SKIP_FILE_HASH" = "$EXPECTED_SKIP_HASH" ]; then
              echo "skip=true" >> $GITHUB_OUTPUT
              log_success "Skip file verified (hash match)"
              log_warn "CI/CD workflows will be SKIPPED"
            else
              echo "skip=false" >> $GITHUB_OUTPUT
              log_error "Skip file hash mismatch!"
              log_warn "Expected: ${EXPECTED_SKIP_HASH}"
              log_warn "Got:      ${SKIP_FILE_HASH}"
              log_info "Proceeding with CI/CD for security reasons"
            fi
          else
            log_step "verify" "Verifying skip file content (no hash configured)..."
            SKIP_CONTENT=$(cat "$SKIP_FILE" | tr -d '[:space:]')
            if [ "$SKIP_CONTENT" = "SKIP_CLAUDE_CI_APPROVED" ]; then
              echo "skip=true" >> $GITHUB_OUTPUT
              log_success "Skip file verified (content match)"
              log_warn "CI/CD workflows will be SKIPPED"
            else
              echo "skip=false" >> $GITHUB_OUTPUT
              log_error "Skip file has invalid content!"
              log_warn "Expected: 'SKIP_CLAUDE_CI_APPROVED'"
              log_warn "Got:      '${SKIP_CONTENT}'"
              log_info "Proceeding with CI/CD for security reasons"
              log_info "See .github/skips/SKIP_SYSTEM.md for setup instructions"
            fi
          fi

          log_info "Workflow log saved to: ${LOG_FILE}"

      # Note: Logs are uploaded as artifacts here, but committed by the calling workflow
      - name: Upload skip check logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: skip-check-logs
          path: .github/workflows/logs/
          retention-days: 30
